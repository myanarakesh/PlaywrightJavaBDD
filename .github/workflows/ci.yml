name: Playwright Automation Suite

on:
  schedule:
    # Runs every day at 10:00 AM IST (04:30 AM UTC)
    - cron: '30 4 * * *'
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'

      - name: Cache Maven dependencies
        uses: actions/cache@v4
        with:
          path: ~/.m2
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-

      - name: Install Playwright WebKit Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            libwoff1 \
            libopus0 \
            libwebpdemux2 \
            libwebpmux3 \
            libenchant-2-2 \
            libhyphen0 \
            libgles2 \
            libevent-2.1-7 \
            libxcomposite1 \
            libxdamage1 \
            libxfixes3 \
            libxrandr2 \
            libgbm1 \
            libpango-1.0-0 \
            libcairo2 \
            libasound2 \
            libatk1.0-0 \
            libatk-bridge2.0-0 \
            libgtk-3-0

      - name: Install Playwright Browsers
        run: mvn exec:java -Dexec.mainClass=com.microsoft.playwright.CLI -Dexec.args="install"

      - name: Start Xvfb for Headed Mode
        run: |
          sudo apt-get update
          sudo apt-get install -y xvfb
          Xvfb :99 -screen 0 1920x1080x24 &
          echo "DISPLAY=:99" >> $GITHUB_ENV

      - name: Run Playwright Tests
        run: mvn clean test
        env:
          DISPLAY: :99

      - name: Upload Extent Report Artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ExtentReport-${{ github.run_number }}
          path: target/ExtentReports/

#      - name: Send report email
#        uses: dawidd6/action-send-mail@v3
#        with:
#          server_address: smtp.gmail.com
#          server_port: 465
#          username: myanarocky@gmail.com
#          password: qnnmhrokavwkqqdv
#          subject: "Daily Playwright Automation Report - ${{ github.run_number }}"
#          to: "myanarakesh@outlook.com"
#          from: "Playwright Automation myanarocky@gmail.com"
#          html_body: |
#            Hi Team,
#
#            Please find attached the latest Playwright Extent Report for today's automation run.
#
#            ðŸ“… Date: ${{ github.run_started_at }}
#            ðŸ“„ Repository: ${{ github.repository }}
#
#            Regards,
#            Playwright Automation Bot
#          attachments: target/ExtentReports/ExtentReport.html